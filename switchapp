#!/bin/bash

desktopid=$(xdotool get_desktop)
exp=$desktopid'$'

lineseparated_ids=$(wmctrl -l | sed -n "s/\(0x[0-9a-zA-Z]\+\)\s\+${desktopid}.*/\1/p")
echo "lineseparated_id=$lineseparated_ids"

IFS=$'\n' read -d '' -r -a ids <<< "$lineseparated_ids"
echo "ids=${ids[@]}"

length=${#ids[@]}
echo "length=$length"

active_id=$(printf 0x%x $(xdotool getactivewindow)) # convert from dec to hex
echo "active_id=$active_id"
if [[ $active_id -eq 0x0 ]]; then 
	active_id=${ids[0]}
	echo "> No active window (may be all are minimized) so defaulting to the first window (winid=$active_id) among the opening ones."
fi

reverse=false
if [[ $1 = "reverse" ]]; then reverse=true; fi
echo "reverse=$reverse"

for ((i=0; i<length; i++))
do
	echo xxx
	echo "active_id=$active_id, id[$i]=${ids[$i]}"
	
	if [[ $active_id -eq ${ids[$i]} ]]; then
		echo yyy
	
		next_idx=-1
		
		if [[ $reverse = "true" ]]; then
			echo "aaa"
			
			next_idx=$((i-1))
			if [[ next_idx -lt 0 ]]; then
				echo aaa1
				next_idx=$((length-1))
			fi
		else
			echo bbb
			
			next_idx=$((i+1))
			if [[ next_idx -eq $length ]]; then
				echo bbb1
				next_idx=0
			fi
		fi
		
		next_id=${ids[$next_idx]}
		dec_nextid=$(printf %i $next_id)
		
		echo "> Activate next window $next_id (dec=$dec_nextid) [i=$i, next_idx=$next_idx]"
		
		xdotool windowactivate $dec_nextid
		
		break
	fi
done

